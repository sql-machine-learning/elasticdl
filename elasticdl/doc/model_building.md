# ElasticDL Model Building
To submit an ElasticDL job, a user needs to provide a model file, such as [`mnist_functional_api.py`](../../model_zoo/mnist_functional_api/mnist_functional_api.py) used in this [example](elastic_scheduling.md#submit-the-first-job-with-low-priority).

This model file contains a [`ElasticDLSpec`](#ElasticDLSpec). It describes functions that ElasticDL needs in order to train models. The `ElasticDLSpec` contains [create\_dataset](#create_dataset), [create\_loss](#create_loss), [create\_optimizer](#create_optimizer), and [create\_metrics](#create_metrics).

## Model File Components

### ElasticDLSpec
`model` is a Keras model built using either TensorFlow Keras [functional API](https://www.tensorflow.org/guide/keras#functional_api) or [model subclassing](https://www.tensorflow.org/guide/keras#model_subclassing).

The following example shows a `model` using functional API, which has one input with shape (28, 28), and one putput with shape (10,):

```
from elastic.python.training import ElasticDLSpec

class ModelUsingFunctionalAPIElasticDLSpec(ElasticDLSpec):

    def __init__(self, context=None):
        super(ModelUsingFunctionalAPIElasticDLSpec, self).__init__(context=context)

    def create_model(self):
        inputs = tf.keras.Input(shape=(28, 28), name='image')
        x = tf.keras.layers.Reshape((28, 28, 1))(inputs)
        x = tf.keras.layers.Conv2D(32, kernel_size=(3, 3), activation='relu')(x)
        x = tf.keras.layers.Conv2D(64, kernel_size=(3, 3), activation='relu')(x)
        x = tf.keras.layers.BatchNormalization()(x)
        x = tf.keras.layers.MaxPooling2D(pool_size=(2, 2))(x)
        x = tf.keras.layers.Dropout(0.25)(x)
        x = tf.keras.layers.Flatten()(x)
        outputs = tf.keras.layers.Dense(10)(x)
        return tf.keras.Model(inputs=inputs, outputs=outputs, name='mnist_model')

     # implement other abstract methods

model = ModelUsingFunctionalAPIElasticDLSpec.create_model()
```

Another example using model subclassing:

```
from elastic.python.training import ElasticDLSpec

class MnistModel(tf.keras.Model):

    def __init__(self):
        super(MnistModel, self).__init__(name="mnist_model")
        self._reshape = tf.keras.layers.Reshape((28, 28, 1))
        self._conv1 = tf.keras.layers.Conv2D(
            32, kernel_size=(3, 3), activation='relu')
        self._conv2 = tf.keras.layers.Conv2D(
            64, kernel_size=(3, 3), activation='relu')
        self._batch_norm = tf.keras.layers.BatchNormalization()
        self._maxpooling = tf.keras.layers.MaxPooling2D(
            pool_size=(2, 2))
        self._dropout = tf.keras.layers.Dropout(0.25)
        self._flatten = tf.keras.layers.Flatten()
        self._dense = tf.keras.layers.Dense(10)

    def call(self, inputs, training=False):
        x = self._reshape(inputs)
        x = self._conv1(x)
        x = self._conv2(x)
        x = self._batch_norm(x, training=training)
        x = self._maxpooling(x)
        if training:
            x = self._dropout(x, training=training)
        x = self._flatten(x)
        x = self._dense(x)
        return x


class ModelUsingSubclassElasticDLSpec(ElasticDLSpec):
    def __init__(self, context=None):
        super(ModelUsingSubclassElasticDLSpec, self).__init__(context=context)

    def create_model(self):
        return MnistModel()

    # implement other abstract methods

model = ModelUsingSubclassElasticDLSpec.create_model()
```
### create_dataset

```
create_dataset(self, dataset, mode)
```
`dataset_fn` is a function that takes a RecordIO `dataset` as input, preprocesses the data as needed, and returns the a dataset containing `model_inputs` and `labels` as a pair.

Argument:

- dataset: a RecordIO dataset generated by ElasticDL. ElasticDL creates a dataset by iterating records from [RecordIO](https://github.com/wangkuiyi/recordio) file.
- mode: This can be any values in defined `from elasticdl.python.common.constants.Mode` representing different phases such as training
evaluation, and prediction. For example, if `mode == Mode.Prediction`, we don't need to return labels inside `_parse_data()`.

Output: a dataset, each data is a tuple (`model_inputs`, `labels`)

`model_inputs` is a dictionary of tensors, which will be used as [model](#model) input. `labels` will be used as an input argument in [loss](#loss).

Example:

```
def create_dataset(self, dataset, mode):
    def _parse_data(record):
        if mode == Mode.PREDICTION:
            feature_description = {
                "image": tf.io.FixedLenFeature([28, 28], tf.float32)
            }
        else:
            feature_description = {
                "image": tf.io.FixedLenFeature([28, 28], tf.float32),
                "label": tf.io.FixedLenFeature([1], tf.int64),
            }
        r = tf.io.parse_single_example(record, feature_description)
        features = {
            "image": tf.math.divide(tf.cast(r["image"], tf.float32), 255.0)
        }
        if mode == Mode.PREDICTION:
            return features
        else:
            return features, tf.cast(r["label"], tf.int32)

    dataset = dataset.map(_parse_data)

    if mode != Mode.PREDICTION:
        dataset = dataset.shuffle(buffer_size=1024)
    return dataset
```

### create_loss
```
create_loss(self, outputs=None, labels=None)
```
`create_loss` is the loss function used in ElasticDL training. It returns the loss tensor.

Arguments:

- outputs:  [model](#create_model)'s output.

- labels: `labels` from [`create_dataset`](#create_dataset).

Example:

```
def create_loss(self, outputs=None, labels=None):
    return tf.reduce_mean(
        input_tensor=tf.nn.sparse_softmax_cross_entropy_with_logits(
            logits=outputs, labels=labels.flatten()
        )
    )
```

### create_optimizer
```
create_optimizer(self, lr=0.1)
```
`create_optimizer` is a function returns a [`tf.train.Optimizer`](https://www.tensorflow.org/api_docs/python/tf/train/Optimizer).

Example:

```
def create_optimizer(self, lr=0.1):
    return tf.optimizers.SGD(lr)
```

### create_metrics
```
def create_metrics(self,
            mode=Mode.TRAINING,
            outputs=None,
            labels=None)
```
`create_metrics` is a function that returns a dictionary where the key is name of the metric and the value
is the metric result from the `outputs` and `labels` , or `labels` using TensorFlow API. For example,
if mode equals `Mode.EVALUATION`, the returned metric dict is used to evaluate the model.

Example:

```
def create_metrics(self,
            mode=Mode.TRAINING,
            outputs=None,
            labels=None):
    if mode == Mode.EVALUATION:
        return {
            "accuracy": tf.reduce_mean(
            input_tensor=tf.cast(
                tf.equal(
                    tf.argmax(input=outputs, axis=1), labels.flatten()
                ),
                tf.float32,
            )
         )
        }
    else:
        return {}
```

By default, it returns an empty dict.

### prepare_data_for_a_single_file
```
prepare_data_for_a_single_file(filename)
```
`prepare_data_for_a_single_file` is to read a single file and do whatever 
user-defined logic to prepare the data (e.g, IO from the user's file system, feature engineering), and return the serialized data. The function can be used to process data for training, evaluation and prediction. The only difference between prediction data with training/evaluation data is that the 'label' in prediction data should be empty. Users should be able to determine if the data file contains label (e.g, via the different formats of filename) and implement the logic to prepare the data accordingly.

Example:

```
def prepare_data_for_a_single_file(filename):
    '''
    An image classification dataset that images belonging to the same category located in the same directory.
    '''
    label = int(filename.split('/')[-2])
    image = PIL.Image.open(filename)
    numpy_image = np.array(image)
    example_dict = {
        "image": tf.train.Feature(
            float_list=tf.train.FloatList(value=numpy_image.flatten())
        ),
        "label": tf.train.Feature(
            int64_list=tf.train.Int64List(value=[label])
        ),
    }
    example = tf.train.Example(
        features=tf.train.Features(feature=example_dict)
    )
    return example.SerializeToString()
```


## Model Building Examples
### [MNIST model using Keras functional API](../../model_zoo/mnist_functional_api/mnist_functional_api.py)
### [MNIST model using Keras model subclassing](../../model_zoo/mnist_subclass/mnist_subclass.py)
### [CIFAR10 model using Keras functional API](../../model_zoo/cifar10_functional_api/cifar10_functional_api.py)
### [CIFAR10 model using Keras model subclassing](../../model_zoo/cifar10_subclass/cifar10_subclass.py)
