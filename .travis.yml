language: minimal

addons:
  apt:
    packages:
      - docker-ce

install:
  - set -e
  - docker version
  - docker build --build-arg BUILD_ENV=no_data -t elasticdl:dev -f elasticdl/docker/Dockerfile .

stages:
  - precommit
  - unittest

jobs:
  include:
    - stage: precommit
      name: "Pre-commit Check"
      script:
        - docker run --rm -it -v $(pwd):/v -w /v elasticdl:dev bash -c "pre-commit run --files $(find elasticdl/python -name *.py -print0 | tr '\0' ' ')"
    - stage: unittest
      name: "Unit Tests"
      script:
        - docker run --rm -it -v $(pwd):/v -w /v elasticdl:dev bash -c "make && K8S_TESTS=False pytest elasticdl/python/tests"
